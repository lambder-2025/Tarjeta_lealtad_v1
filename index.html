<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Lealtad</title>
    <!-- === PWA HEADERS === -->
    <meta name="theme-color" content="#2563EB"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2563EB/FFFFFF?text=L">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @import url('https://rsms.me/inter/inter.css');
        #qr-reader { border: 2px dashed #cbd5e1; border-radius: 8px; overflow: hidden; }
        #qr-reader video { width: 100% !important; height: auto !important; }
    </style>
</head>
<body class="bg-white text-gray-800">

    <!-- ===== LOADER AND TOAST (GLOBAL) ===== -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- ===== CLIENT VIEW (DEFAULT) ===== -->
    <div id="client-view" class="view">
        <div class="container mx-auto p-6 max-w-md min-h-screen flex flex-col justify-center">
            <!-- Client Login Form -->
            <div id="client-login-section">
                 <header class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-900">Tarjeta de Lealtad</h1>
                    <p class="text-gray-600 mt-2">Consulta tus visitas y recompensas.</p>
                </header>
                <div class="space-y-4">
                    <input type="tel" id="client-telefono" placeholder="Tu Teléfono" class="input-field-visual">
                    <input type="text" id="client-fechaNacimiento" placeholder="Tu Fecha de Nacimiento" class="input-field-visual" onfocus="(this.type='date')">
                    <button id="view-card-btn" class="btn-primary-visual w-full">Consultar / Refrescar</button>
                </div>
            </div>

            <!-- Client Loyalty Card (New Design) -->
            <div id="client-card-section" style="display: none;" class="text-center">
                 <button onclick="showView('client-view', true)" class="absolute top-6 left-6 text-gray-500 hover:text-gray-800 transition">&larr; Volver</button>
                <h2 class="text-3xl font-bold mb-2" id="client-name"></h2>
                <p class="text-gray-500 mb-4">Número total de visitas</p>
                <p class="text-8xl font-bold text-blue-600 my-4" id="client-visits"></p>
                <div id="qrcode" class="flex justify-center p-2 bg-white my-6"></div>
                <div id="rewards-list" class="space-y-3 text-left w-full"></div>
                <!-- === MEJORAS VISUALES === -->
                <p class="text-xs text-gray-400 mt-4">Las recompensas en verde ✅ ya están disponibles para canjear en tienda.</p>
                <p class="text-xs text-gray-400 mt-2">Última actualización: <span id="last-updated">Nunca</span></p>
            </div>
        </div>
    </div>

    <!-- ===== ADMIN LOGIN MODAL (HIDDEN BY DEFAULT) ===== -->
    <div id="login-view" class="view fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-40" style="display: none;">
         <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-semibold text-center mb-6">Acceso de Administrador</h2>
            <div class="space-y-4">
                <input type="text" id="admin-user" placeholder="Usuario (ej. admin)" class="input-field">
                <input type="password" id="admin-pass" placeholder="Contraseña" class="input-field">
                <button id="admin-login-btn" class="btn-primary w-full">Ingresar</button>
                <button onclick="showView('client-view')" class="btn-secondary w-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- ===== ADMIN PANEL VIEW (HIDDEN BY DEFAULT) ===== -->
    <div id="admin-panel" class="view bg-gray-50" style="display: none;">
        <!-- (El resto del HTML no cambia) -->
        <div class="container mx-auto p-4 md:p-6 max-w-4xl"><header class="mb-6 flex justify-between items-center"><div><h1 class="text-3xl font-bold text-gray-900">Panel de Administrador</h1><p class="text-gray-600">Gestión del Sistema de Lealtad</p></div><button onclick="logoutAdmin()" class="btn-secondary">Salir</button></header><nav class="flex justify-center border-b-2 border-gray-200 mb-6"><button onclick="showAdminSection('vendor-section')" class="nav-tab active-tab" data-section="vendor-section">Vendedor</button><button onclick="showAdminSection('comms-section')" class="nav-tab" data-section="comms-section">Comunicación</button><button onclick="showAdminSection('master-section')" class="nav-tab" data-section="master-section">Panel Maestro</button></nav><main><section id="vendor-section" class="admin-section"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-4">Gestión de Clientes</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><input type="text" id="nombre" placeholder="Nombre Completo" class="input-field"><input type="tel" id="telefono" placeholder="Teléfono" class="input-field"><input type="text" id="fechaNacimiento" placeholder="Fecha de Nacimiento" class="input-field" onfocus="(this.type='date')"><button id="search-create-btn" class="btn-primary md:col-span-2">Buscar o Crear Tarjeta</button></div><div class="text-center mb-6"><button id="start-scan-btn" class="btn-secondary">Escanear QR</button><div id="qr-reader-container" class="mt-4 w-full max-w-sm mx-auto" style="display: none;"><div id="qr-reader"></div><button id="stop-scan-btn" class="btn-danger mt-2">Detener Escáner</button></div></div><div id="client-panel" style="display: none;" class="mt-6 border-t pt-6"><h3 class="text-xl font-semibold mb-4">Información del Cliente</h3><div id="client-info" class="mb-4 bg-blue-50 p-4 rounded-lg"></div><div class="flex flex-wrap gap-4 items-center"><button id="add-visit-btn" class="btn-success">+1 Visita</button><div class="flex items-center gap-2"><select id="rewards-select" class="input-field"></select><button id="redeem-reward-btn" class="btn-warning flex-shrink-0">Canjear</button></div></div></div><div class="mt-8"><h3 class="text-xl font-semibold mb-4">Lista de Clientes</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr><th class="table-header">Nombre</th><th class="table-header">Visitas</th><th class="table-header">Teléfono</th><th class="table-header">Folio</th></tr></thead><tbody id="client-list-body"></tbody></table></div></div></div></section><section id="comms-section" class="admin-section" style="display: none;"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-4">Comunicación Interna</h2><div class="space-y-4"><div id="messages-container" class="h-80 overflow-y-auto border p-4 rounded-lg bg-gray-50 flex flex-col-reverse"></div><div class="flex gap-2"><input type="text" id="message-input" placeholder="Escribe tu mensaje..." class="input-field flex-grow"><button id="send-message-btn" class="btn-primary">Enviar</button></div></div></div></section><section id="master-section" class="admin-section" style="display: none;"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-4">Panel de Control Maestro</h2><div class="mb-6 p-4 border border-yellow-300 bg-yellow-50 rounded-lg"><h3 class="text-xl font-medium mb-2">Seguridad</h3><p class="text-sm text-yellow-800 mb-2">Establece o actualiza la contraseña. Si no hay contraseña, la primera que guardes será la nueva.</p><input type="password" id="new-admin-password" class="input-field w-64" placeholder="Nueva Contraseña"></div><div class="mb-6"><h3 class="text-xl font-medium mb-2">Reglas Generales</h3><div class="flex items-center gap-4"><label for="visits-to-complete" class="font-medium">Visitas para Recompensa:</label><input type="number" id="visits-to-complete" class="input-field w-24"></div></div><div><h3 class="text-xl font-medium mb-2">Gestionar Recompensas</h3><div id="rewards-editor" class="space-y-3 mb-4"></div><button id="add-reward-btn" class="btn-secondary">+ Añadir Recompensa</button></div><div class="mt-8 border-t pt-6 text-right"><button id="save-config-btn" class="btn-success">Guardar Configuración</button></div></div></section></main></div>
    </div>
    
    <style>
        .input-field { @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white; }
        .input-field-visual { @apply w-full text-center text-lg px-4 py-3 bg-gray-100 border-2 border-transparent rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition; }
        .btn-primary-visual { @apply w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 text-lg; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300; }
        .btn-success { @apply bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300; }
        .btn-warning { @apply bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-300; }
        .btn-danger { @apply bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300; }
        .nav-tab { @apply px-4 py-2 text-lg font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition; }
        .nav-tab.active-tab { @apply text-blue-600 border-blue-600; }
        .table-header { @apply p-3 text-sm font-semibold tracking-wide text-left bg-gray-100 border-b-2; }
    </style>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykaQZLUjU3A_P9AI6aOQyy4qFIWZd_teeFBxUCwOH47PMhZnzUuVhBQG9oXYcretGKOg/exec';

// --- GLOBAL STATE ---
let currentClient = null, allClients = [], appConfig = {}, html5QrCode = null, currentSender = 'Vendedor';
const loader = document.getElementById('loader');
let secretClickCount = 0;
let lastClickTimestamp = 0;

// --- CORE APP LOGIC ---
const showLoader = () => loader.style.display = 'flex';
const hideLoader = () => loader.style.display = 'none';

function showToast(message, isError = false) {
    const toast = document.getElementById('toast'), toastMessage = document.getElementById('toast-message');
    toastMessage.textContent = message;
    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
    toast.classList.remove('opacity-0');
    setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
}

function showView(viewId, resetClientForm = false) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = viewId === 'login-view' ? 'flex' : 'block';
    }
    if (resetClientForm) {
        const savedData = localStorage.getItem('loyaltyCardData');
        if (savedData) {
            localStorage.removeItem('loyaltyCardData');
        }
        document.getElementById('client-login-section').style.display = 'block';
        document.getElementById('client-card-section').style.display = 'none';
        document.getElementById('client-telefono').value = '';
        document.getElementById('client-fechaNacimiento').value = '';
    }
}

async function apiCall(action, payload, method = 'POST') {
    showLoader();
    try {
        if (!navigator.onLine) {
            throw new Error("No hay conexión a internet.");
        }
        let response;
        if (method === 'GET') {
            const params = new URLSearchParams(payload);
            response = await fetch(`${SCRIPT_URL}?action=${action}&${params.toString()}`);
        } else {
            response = await fetch(SCRIPT_URL, { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, ...payload }) });
        }
        if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return result;
    } catch (error) {
        showToast(error.message || 'Error de conexión.', true);
        console.error("API Call Error:", error);
        return null;
    } finally {
        hideLoader();
    }
}

// --- CLIENT VIEW LOGIC (CON MEJORAS OFFLINE) ---
async function handleViewCard() {
    const telefono = document.getElementById('client-telefono').value.trim();
    const fechaNacimiento = document.getElementById('client-fechaNacimiento').value;
    if (!telefono || !fechaNacimiento) return showToast('Todos los campos son requeridos.', true);

    const clientResult = await apiCall('buscarClientePorCredenciales', { telefono, fechaNacimiento }, 'GET');
    
    if (clientResult) {
        const configResult = await apiCall('obtenerConfiguracion', {}, 'GET');
        if (configResult) {
            const cardData = {
                client: clientResult.data,
                config: configResult.data,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('loyaltyCardData', JSON.stringify(cardData));
            displayCard(cardData.client, cardData.config, cardData.lastUpdated);
            document.getElementById('client-login-section').style.display = 'none';
            document.getElementById('client-card-section').style.display = 'block';
        }
    }
}

function displayCard(clientData, configData, lastUpdated) {
    document.getElementById('client-name').textContent = clientData.nombre;
    document.getElementById('client-visits').textContent = clientData.visitas;
    const qrcodeContainer = document.getElementById('qrcode');
    qrcodeContainer.innerHTML = '';
    new QRCode(qrcodeContainer, { text: clientData.folio, width: 160, height: 160, colorDark : "#000000", colorLight : "#ffffff" });
    document.getElementById('last-updated').textContent = new Date(lastUpdated).toLocaleString();
    
    const rewardsList = document.getElementById('rewards-list');
    rewardsList.innerHTML = '';
    const checkIcon = `<svg class="w-6 h-6 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
    const hourglassIcon = `<svg class="w-6 h-6 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
    (configData.rewards || []).forEach(reward => {
        const isEligible = parseInt(clientData.visitas) >= parseInt(reward.valor);
        const rewardElement = document.createElement('div');
        rewardElement.className = `p-4 rounded-xl flex items-center font-medium shadow-sm transition ${isEligible ? 'bg-green-50 text-green-800' : 'bg-gray-100 text-gray-600'}`;
        rewardElement.innerHTML = `${isEligible ? checkIcon : hourglassIcon}<span>${reward.clave} <span class="text-xs opacity-75">(${reward.valor} visitas)</span></span>`;
        rewardsList.appendChild(rewardElement);
    });
}

// --- ADMIN & OTHER LOGIC ---
// (Las funciones de admin, etc., no cambian su lógica interna)
async function handleAdminLogin() { /* ... */ }
async function handleSearchOrCreate() { /* ... */ }
async function handleAddVisit() { /* ... */ }
async function handleRedeemReward() { /* ... */ }
async function fetchClientList() { /* ... */ }
function updateClientPanel() { /* ... */ }
function renderClientList() { /* ... */ }
function onScanSuccess(decodedText, decodedResult) { /* ... */ }
function onScanFailure(error) {}
function startScanner() { /* ... */ }
function stopScanner() { /* ... */ }
async function fetchMessages() { /* ... */ }
async function handleSendMessage() { /* ... */ }
function renderMessages(messages) { /* ... */ }
async function loadConfigForEditing() { /* ... */ }
function renderRewardsEditor() { /* ... */ }
function addReward() { /* ... */ }
function removeReward(index) { /* ... */ }
async function saveConfiguration() { /* ... */ }


document.addEventListener('DOMContentLoaded', () => {
    // --- LÓGICA DE CARGA INICIAL MEJORADA ---
    const savedData = localStorage.getItem('loyaltyCardData');
    if (savedData) {
        const cardData = JSON.parse(savedData);
        displayCard(cardData.client, cardData.config, cardData.lastUpdated);
        document.getElementById('client-login-section').style.display = 'none';
        document.getElementById('client-card-section').style.display = 'block';
    } else {
        showView('client-view');
    }

    // --- EVENT LISTENERS ---
    const viewCardBtn = document.getElementById('view-card-btn');
    viewCardBtn.addEventListener('click', () => {
        const telefonoInput = document.getElementById('client-telefono');
        const currentTime = Date.now();
        if (telefonoInput.value.trim() === '12345') {
            if (currentTime - lastClickTimestamp > 1000) { secretClickCount = 0; }
            secretClickCount++;
            lastClickTimestamp = currentTime;
            if (secretClickCount >= 10) {
                secretClickCount = 0;
                showView('login-view');
                return;
            }
        } else {
            handleViewCard();
        }
    });

    document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
    // ... (resto de listeners)
});

// --- PWA SERVICE WORKER ---
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service worker registered!'))
        .catch(err => console.log('Service worker registration failed:', err));
}

// --- DEFINICIONES COMPLETAS DE FUNCIONES RESTANTES ---
// (Para evitar errores, se incluyen todas las funciones aunque no hayan cambiado)
async function handleAdminLogin(){const user=document.getElementById("admin-user").value.trim(),pass=document.getElementById("admin-pass").value.trim();if(!user||!pass)return showToast("Usuario y contraseña son requeridos.",!0);const passwordHash=await hashPassword(pass),result=await apiCall("verificarAccesoMaestro",{usuario:user,passwordHash:passwordHash});result&&(showToast("Acceso concedido."),showView("admin-panel"),currentSender="Maestro",fetchClientList(),loadConfigForEditing())}async function handleSearchOrCreate(){const nombre=document.getElementById("nombre").value.trim(),telefono=document.getElementById("telefono").value.trim(),fechaNacimiento=document.getElementById("fechaNacimiento").value;if(!nombre||!telefono||!fechaNacimiento)return showToast("Todos los campos son requeridos.",!0);const result=await apiCall("buscarOcrearTarjeta",{nombre:nombre,telefono:telefono,fechaNacimiento:fechaNacimiento});result&&(currentClient=result.data,showToast(result.message),updateClientPanel(),fetchClientList())}async function handleAddVisit(){if(currentClient){const result=await apiCall("registrarVisita",{folio:currentClient.folio});result&&(currentClient.visitas=result.newVisits,showToast("Visita registrada."),updateClientPanel(),fetchClientList())}}async function handleRedeemReward(){if(currentClient){const rewardsSelect=document.getElementById("rewards-select"),selectedCost=rewardsSelect.value,selectedName=rewardsSelect.options[rewardsSelect.selectedIndex].text.split(" (")[0];if(!selectedCost)return showToast("Selecciona una recompensa.",!0);if(parseInt(currentClient.visitas)<parseInt(selectedCost))return showToast("Visitas insuficientes.",!0);const result=await apiCall("canjearRecompensa",{folio:currentClient.folio,nombreCliente:currentClient.nombre,recompensa:selectedName,costo:selectedCost});result&&(currentClient.visitas=result.newVisits,showToast(`'${selectedName}' canjeada.`),updateClientPanel(),fetchClientList())}}async function fetchClientList(){const result=await apiCall("listarTarjetas",{},"GET");result&&(allClients=result.data,renderClientList())}function updateClientPanel(){const clientPanel=document.getElementById("client-panel"),clientInfo=document.getElementById("client-info");currentClient?(clientInfo.innerHTML=`<p><strong>Nombre:</strong> ${currentClient.nombre}</p><p><strong>Visitas:</strong> <span class="text-2xl font-bold text-blue-600">${currentClient.visitas}</span></p><p><strong>Folio:</strong> ${currentClient.folio}</p>`,clientPanel.style.display="block"):(clientPanel.style.display="none")}function renderClientList(){const tbody=document.getElementById("client-list-body");tbody.innerHTML=(allClients||[]).map(c=>`<tr class="border-b hover:bg-gray-50"><td class="p-3">${c.nombre}</td><td class="p-3 font-bold">${c.visitas}</td><td class="p-3">${c.telefono}</td><td class="p-3 text-sm text-gray-600">${c.folio}</td></tr>`).join("")}function onScanSuccess(decodedText,decodedResult){stopScanner();const client=allClients.find(c=>c.folio===decodedText);client?(document.getElementById("nombre").value=client.nombre||"",document.getElementById("telefono").value=client.telefono||"",document.getElementById("fechaNacimiento").value=client.fechaNacimiento||"",currentClient=client,updateClientPanel(),showToast("Cliente encontrado por QR.")):showToast("Cliente no encontrado con este QR.",!0)}function startScanner(){html5QrCode||(html5QrCode=new Html5Qrcode("qr-reader"));const qrReaderContainer=document.getElementById("qr-reader-container");qrReaderContainer.style.display="block";const config={fps:10,qrbox:{width:250,height:250}};html5QrCode.start({facingMode:"environment"},config,onScanSuccess,onScanFailure).catch(err=>{showToast("Error al iniciar escáner. Revisa los permisos de la cámara.",!0),qrReaderContainer.style.display="none"})}function stopScanner(){html5QrCode&&html5QrCode.isScanning&&html5QrCode.stop().then(()=>{document.getElementById("qr-reader-container").style.display="none"}).catch(err=>console.error("Error al detener el escáner.",err))}async function fetchMessages(){const result=await apiCall("obtenerMensajes",{},"GET");result&&renderMessages(result.data)}async function handleSendMessage(){const messageInput=document.getElementById("message-input"),message=messageInput.value.trim();if(message){const result=await apiCall("enviarMensaje",{remitente:currentSender,mensaje:message});result&&(messageInput.value="",fetchMessages())}}function renderMessages(messages){const container=document.getElementById("messages-container");container.innerHTML=(messages||[]).map(msg=>`<div class="p-3 rounded-lg max-w-xs mb-2 ${msg.sender===currentSender?"bg-blue-500 text-white self-end":"bg-gray-200 self-start"}"><p class="font-bold text-sm">${msg.sender}</p><p>${msg.message}</p><p class="text-xs opacity-70 text-right">${(new Date(msg.timestamp)).toLocaleTimeString()}</p></div>`).join("")}async function loadConfigForEditing(){const result=await apiCall("obtenerConfiguracion",{},"GET");result&&(appConfig=result.data,document.getElementById("visits-to-complete").value=appConfig.rules.VisitasParaCompletar||10,()=>{const rewardsSelect=document.getElementById("rewards-select");rewardsSelect.innerHTML='<option value="">-- Canjear Recompensa --</option>',(appConfig.rewards||[]).forEach(r=>{rewardsSelect.innerHTML+=`<option value="${r.valor}">${r.clave} (${r.valor} visitas)</option>`})}(),renderRewardsEditor())}function renderRewardsEditor(){const editor=document.getElementById("rewards-editor");editor.innerHTML=(appConfig.rewards||[]).map((reward,index)=>`<div class="flex items-center gap-2 p-2 bg-gray-50 rounded"><input type="text" value="${reward.clave}" data-index="${index}" class="input-field reward-name flex-grow" placeholder="Nombre recompensa"><input type="number" value="${reward.valor}" data-index="${index}" class="input-field reward-cost w-24" placeholder="Costo"><button class="btn-danger text-sm py-1 px-2" onclick="removeReward(${index})">X</button></div>`).join("")}function addReward(){appConfig.rewards||(appConfig.rewards=[]),appConfig.rewards.push({clave:"",valor:""}),renderRewardsEditor()}function removeReward(index){appConfig.rewards.splice(index,1),renderRewardsEditor()}async function saveConfiguration(){const newConfig={rules:{VisitasParaCompletar:document.getElementById("visits-to-complete").value},rewards:[]};document.querySelectorAll(".reward-name").forEach((nameInput,i)=>{const costInput=document.querySelectorAll(".reward-cost")[i];nameInput.value&&costInput.value&&newConfig.rewards.push({clave:nameInput.value.trim(),valor:costInput.value.trim()})});const newPassword=document.getElementById("new-admin-password").value.trim();newPassword&&(newConfig.passwordHash=await hashPassword(newPassword));const result=await apiCall("guardarConfiguracion",{config:newConfig});result&&(showToast("Configuración guardada."),document.getElementById("new-admin-password").value="",loadConfigForEditing())}document.addEventListener("DOMContentLoaded",()=>{const savedData=localStorage.getItem("loyaltyCardData");savedData?(()=>{const cardData=JSON.parse(savedData);displayCard(cardData.client,cardData.config,cardData.lastUpdated),document.getElementById("client-login-section").style.display="none",document.getElementById("client-card-section").style.display="block"})():showView("client-view",!0);const viewCardBtn=document.getElementById("view-card-btn");viewCardBtn.addEventListener("click",()=>{const telefonoInput=document.getElementById("client-telefono"),currentTime=Date.now();"12345"===telefonoInput.value.trim()?(1e3<currentTime-lastClickTimestamp&&(secretClickCount=0),secretClickCount++,lastClickTimestamp=currentTime,10<=secretClickCount&&(secretClickCount=0,showView("login-view"))):(secretClickCount=0,handleViewCard())}),document.getElementById("admin-login-btn").addEventListener("click",handleAdminLogin),document.getElementById("search-create-btn").addEventListener("click",handleSearchOrCreate),document.getElementById("add-visit-btn").addEventListener("click",handleAddVisit),document.getElementById("redeem-reward-btn").addEventListener("click",handleRedeemReward),document.getElementById("start-scan-btn").addEventListener("click",startScanner),document.getElementById("stop-scan-btn").addEventListener("click",stopScanner),document.getElementById("send-message-btn").addEventListener("click",handleSendMessage),document.getElementById("add-reward-btn").addEventListener("click",addReward),document.getElementById("save-config-btn").addEventListener("click",saveConfiguration),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js").then(reg=>console.log("Service worker registered!")).catch(err=>console.log("Service worker registration failed:",err))});

</script>

</body>
</html>